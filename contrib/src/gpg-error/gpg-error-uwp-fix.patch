From 9b691eb3b55e4d8ee027e56109081f90cef21dd7 Mon Sep 17 00:00:00 2001
From: Steve Lhomme <robux4@ycbcr.xyz>
Date: Mon, 15 May 2023 08:20:15 +0200
Subject: [PATCH 03/12] fix UWP build

---
 src/mkheader.c                       |  2 +-
 src/syscfg/lock-obj-pub.mingw32uwp.h | 44 ++++++++++++++++++++++++++++
 2 files changed, 45 insertions(+), 1 deletion(-)
 create mode 100644 src/syscfg/lock-obj-pub.mingw32uwp.h

diff --git a/src/mkheader.c b/src/mkheader.c
index 000a224..659508f 100644
--- a/src/mkheader.c
+++ b/src/mkheader.c
@@ -625,7 +625,7 @@ write_special (const char *fname, int lnr, const char *tag)
     }
   else if (!strcmp (tag, "include:os-add"))
     {
-      if (!strcmp (host_os, "mingw32"))
+      if (!strcmp (host_os, "mingw32") || !strcmp (host_os, "mingw32uwp") || !strcmp (host_os, "mingw32ucrt"))
         {
           include_file (fname, lnr, "w32-add.h", write_line);
         }
diff --git a/src/syscfg/lock-obj-pub.mingw32uwp.h b/src/syscfg/lock-obj-pub.mingw32uwp.h
new file mode 100644
index 0000000..f35aee1
--- /dev/null
+++ b/src/syscfg/lock-obj-pub.mingw32uwp.h
@@ -0,0 +1,44 @@
+## w32-lock-obj-pub.in - Include fragment for gpg-error.h       -*- c-*-
+## Copyright (C) 2014 g10 Code GmbH
+##
+## This file is free software; as a special exception the author gives
+## unlimited permission to copy and/or distribute it, with or without
+## modifications, as long as this notice is preserved.
+##
+## This file is distributed in the hope that it will be useful, but
+## WITHOUT ANY WARRANTY, to the extent permitted by law; without even the
+## implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
+##
+##
+## This file defines the public version of the lock object for 32 bit
+## Windows.  The actual used version is in w32-lock-obj.h.  This file
+## is inserted into gpg-error.h by mkheader.c.  The tool
+## gen-w32-lock-obj.c has been used to construct it.
+
+#ifdef _WIN64
+
+#pragma pack(push, 8)
+typedef struct
+{
+  volatile unsigned char priv[56];
+} gpgrt_lock_t;
+#pragma pack(pop)
+
+#define GPGRT_LOCK_INITIALIZER {{1,0,0,0,0,0,0,0,255,255,255,255, \
+                                 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, \
+                                 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, \
+                                 0,0,0,0,0,0,0,0,0,0,0,0}}
+
+#else
+
+#pragma pack(push, 8)
+typedef struct
+{
+  volatile unsigned char priv[36];
+} gpgrt_lock_t;
+#pragma pack(pop)
+
+#define GPGRT_LOCK_INITIALIZER {{1,0,0,0,0,0,0,0,255,255,255,255, \
+                                 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, \
+                                 0,0,0,0,0,0,0,0}}
+#endif
-- 
2.45.1.windows.1

